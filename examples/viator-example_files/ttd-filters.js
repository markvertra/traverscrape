function resizeCardsInRow(a){var b=null;$(".ttd-row-"+a+":first .ttd-row-height").innerHeight()>0?_resizeCardsInRow(a):b=window.setInterval(function(){$(".ttd-row-"+a+":first .ttd-row-height").innerHeight()>0&&(_resizeCardsInRow(a),clearInterval(b))},20)}function _resizeCardsInRow(a){var b=0,c=$(".ttd-row-"+a+" .ttd-row-height");c.each(function(){var a=$(this),c=a.innerHeight();c>b&&(b=c)}),c.css("height",b);var d=0,e=$(".ttd-row-"+a);e.each(function(){var a=$(this),b=a.innerHeight();b>d&&(d=b)}),e.css("height",d)}Viator.Filter.view.dateFormat="YYYYMMDD",Viator.Filter.view.dateDisplayFormat="DD MMM YYYY",Viator.Filter.view.busyIndicator=$('<img id="busyIndicator" class="busy" style="display: none;" src="/images/loader/loading_5wbg.gif" />'),Viator.Filter.view.busyIndicator.appendTo("body"),Viator.Filter.view.scrollToTop=function(){$("html, body").animate({scrollTop:Viator.Filter.view.listingContainer.offset().top+"px"},400)},Viator.Filter.view.pageSize=45,Viator.Filter.view.render=$.Deferred(),$(function(){Viator.Filter.view.filterContainer=$(".left-nav"),Viator.Filter.view.listingContainer=$(".product-list")}),Viator.Filter.view.handlebarsCustomizationPromise=$.Deferred(),Viator.Filter.view.initialListRendered=$.Deferred(),Viator.Filter.view.truncateStr=function(a,b){if(a){var c=$.trim(a),d=null;return c.length>b?(d=c.substr(0,b)).substr(0,d.lastIndexOf(" "))+"&nbsp;&hellip;":a}return a},Viator.Filter.view.Money=function(a){this.radixPt=a.slice(-3,-2),this.thousandsSeparator="[.,]".replace(this.radixPt,"");var b=new RegExp(this.thousandsSeparator,"g"),c=a.replace(b,"");","===this.radixPt&&(c=c.replace(",",".")),this.amount=parseFloat(c)},Viator.Filter.view.Money.prototype.formattedAmount=function(){var a=this.amount.toFixed(2);"."!==this.radixPt&&(a=a.replace(".",this.radixPt));var b=new RegExp("(\\d)(?=(\\d{3})+["+this.radixPt+"])","g");return a.replace(b,"$1"+this.thousandsSeparator)},Viator.Filter.view.Money.prototype.minus=function(a){return this.amount=this.amount-a,this},$(function(){Handlebars.registerHelper("replaceStr",function(a,b,c){return a?a.replace(b,c):""}),Handlebars.registerHelper("regexMatch",function(a,b){var c=new RegExp(b,"m");return a&&b&&c.test(a)}),Handlebars.registerHelper("stripHtml",function(a){return a&&a.indexOf("<")>-1?$("<div/>").html(a).text():a}),Handlebars.registerHelper("truncateStr",Viator.Filter.view.truncateStr),Handlebars.registerHelper("isTrue",function(a){return a&&"true"===a}),Handlebars.registerHelper("concatStr",function(a,b){return"".concat(a,b)}),Handlebars.registerHelper("isDiscounted",function(a,b){return a&&b&&new Viator.Filter.view.Money(b).amount>new Viator.Filter.view.Money(a).amount}),Handlebars.registerHelper("priceDiff",function(a,b){return new Viator.Filter.view.Money(a).minus(new Viator.Filter.view.Money(b).amount).formattedAmount()}),Handlebars.registerHelper("resolveDuration",function(a){if(a.s_duration&&a.s_duration.length>0&&a.s_duration[0])return a.s_duration;var b=a.st_durationSort?a.st_durationSort[0]:null;if(!b)return"";var c=parseInt(b);if(c<120)return c+" minute"+(c>1?"s":"");var d=function(a,b){return[a/b,a%b]},e=function(a,b,c){return b>=1&&(a&&(a+=" "),a+=Math.floor(b)+" "+c+(Math.floor(b)>1?"s":"")),a},f=d(c,60),g=d(f[0],24),h=d(g[0],365);return e(e(e(e("",h[0],"year"),h[1],"day"),g[1],"hour"),f[1],"minute")}),Handlebars.registerHelper("groupAndCategory",function(a,b){if(a.st_allGroupNames){if(b&&b.length>0){if(b.indexOf(a.s_primaryGroupName[0])>-1)return a.s_primaryGroupName[0]+" &rsaquo; "+a.s_primaryCategoryName[0];for(var c=0;c<a.st_allGroupNames.length;c++)if(b.indexOf(a.st_allGroupNames[c])>-1)return a.st_allGroupNames[c]+" &rsaquo; "+a.st_allCategoryNames[c];return""}return a.s_primaryGroupName[0]+" &rsaquo; "+a.s_primaryCategoryName[0]}return""}),Handlebars.registerHelper("transformDateString",function(a,b,c){return moment(a,b).format(c)}),Handlebars.registerHelper("or",function(a,b){return a||b}),Handlebars.registerHelper("eq",function(a,b){return a==b}),Handlebars.registerHelper("divInt",function(a,b){return Math.floor(a/b)}),Handlebars.registerHelper("replaceRegExp",function(a,b,c){return a?a.replace(new RegExp(b,"g"),c):""}),Handlebars.registerHelper("leafLookupId",function(a){return a.substr(a.lastIndexOf(".")+1)}),Handlebars.registerPartial("urlSafeText","{{replaceRegExp (replaceRegExp (replaceRegExp (replaceRegExp text \"'\" '') ' ' '-') '&[^;]+;' '') '[^a-zA-Z0-9.-]' ''}}"),Handlebars.registerPartial("productUrl","/tours/{{> urlSafeText text=s_primaryDestName.[0]}}/{{> urlSafeText text=s_entryName.[0]}}/d{{leafLookupId st_primaryLookupID.[0]}}-{{sts_productCode.[0]}}"),Handlebars.registerPartial("appliedFilters",$("#applied-filters-template").html()),Handlebars.registerPartial("pageNavigator",$("#page-navigator-template").html()),Handlebars.registerPartial("sortSelector",$("#sort-selector-template").html()),Handlebars.registerPartial("noResults",$("#no-results-template").html()),Viator.Filter.view.handlebarsCustomizationPromise.resolve()}),Viator.Filter.controller={range:function(a,b){return a=a||1,b>=a?this.range(a,b-1).concat(b):[]},pageNumbers:function(a){return a.totalPages<=a.pageListSize?this.range(1,a.totalPages):a.page>a.totalPages-a.pageListSize?this.range(a.totalPages-a.pageListSize+1,a.totalPages):Math.floor(a.pageListSize/2)>=a.page?this.range(1,a.pageListSize):this.range(a.page-Math.floor(a.pageListSize/2),a.page+Math.floor(a.pageListSize/2)+(a.totalPages%2===0?-1:0))},pageNavElements:function(a){var b={pages:$.map(this.pageNumbers(a),function(b){return{index:b,current:a.page===b}}),prev:a.page>1?a.page-1:null,next:a.page<a.totalPages?a.page+1:null};if(b.pages&&b.pages.length>0){var c=b.pages.pop();c.last=!0,b.pages.push(c)}return b},filterQuery:function(a){var b="";return a.selections&&$.each(a.selections,function(a,c){b+="&criteria."+c.name+"="+c.value}),a.availabilityRange&&(a.availabilityRange.from&&(b+="&criteria.fromDate="+a.availabilityRange.from),a.availabilityRange.to&&(b+="&criteria.toDate="+a.availabilityRange.to)),b},checkBoxDataFilters:function(){return $.map($("[data-filter]:checked"),function(a){var b=$(a);return{name:b.attr("name"),value:b.val()}})},availabilityRangeDataFilter:function(){return{from:Viator.Filter.view.fromDatePicker.toString(Viator.Filter.view.dateFormat),to:Viator.Filter.view.toDatePicker.toString(Viator.Filter.view.dateFormat)}},sortBy:function(a){var b="";return b=void 0!==a&&a&&"SCORE"!=a?"&criteria.sortBy="+a:"&criteria.sortBy="+Viator.Filter.model.popularitySortCriteria},elevate:function(a,b){var c="";if(void 0!==b&&b&&"SCORE"!=b&&"RANK"!=b)c="";else if(a.selections&&0!=a.selections.length||a.availabilityRange&&(a.availabilityRange.from||a.availabilityRange.to)){var d=$.grep(a.selections,function(a){return"topPicks"===a.name});d&&0!=d.length||(c="&criteria.elevateTopPicks=50")}else c="&criteria.elevateTopPicks=3";return c},singleSelection:function(a,b){b.prop("checked")||($(a+" .current-link input").prop("checked",!1),$(a+" .current-link").removeClass("current-link")),b.prop("checked",!b.prop("checked")),b.is(":checked")?(b.parent().addClass("current-link"),Viator.Filter.view.filterContainer.trigger("filterEvent",{type:b.attr("name"),value:b.val()})):b.parent().removeClass("current-link"),Viator.Filter.controller.listProducts({sortBy:Viator.Filter.view.selectedSortBy,layout:Viator.Filter.view.selectedLayout})},listProducts:function(a,b){var c=this;Viator.Filter.view.render.done(function(){var d={listSpec:a||{},filterSpec:{selections:Viator.Filter.controller.checkBoxDataFilters(),availabilityRange:Viator.Filter.controller.availabilityRangeDataFilter()},currency:Viator.Filter.model.currency,destinationId:Viator.Filter.model.destinationId};c.logBrowserHistory(d),c._listProducts(d,b)})},replayQuery:function(a,b){var c=this;Viator.Filter.view.render.done(function(){a=a||{listSpec:{},filterSpec:{},currency:Viator.Filter.model.currency,destinationId:Viator.Filter.model.destinationId};var d=function(a){$("[data-filter]:checked").length>0?setTimeout(function(){d(a)},200):a()};$('[type="checkbox"][data-filter]:checked').prop("checked",!1).trigger("change"),a.filterSpec.selections&&d(function(){$.each(a.filterSpec.selections,function(a,b){$('[data-filter][name="'+b.name+'"][value="'+b.value+'"]').prop("checked",!0).trigger("change")})});var e=a.filterSpec.availabilityRange&&a.filterSpec.availabilityRange.from?moment(a.filterSpec.availabilityRange.from,Viator.Filter.view.dateFormat):null;e?Viator.Filter.view.fromDatePicker.setMoment(e):Viator.Filter.view.fromDatePicker.setDate(null);var f=a.filterSpec.availabilityRange&&a.filterSpec.availabilityRange.to?moment(a.filterSpec.availabilityRange.to,Viator.Filter.view.dateFormat):null;f?Viator.Filter.view.toDatePicker.setMoment(f):Viator.Filter.view.toDatePicker.setDate(null),c._listProducts(a,b)})},_listProductsOverride:null,_listProductsQueryUrl:function(a){var b=a.listSpec?a.listSpec.sortBy:null;return"/api/product.jspa?destinationID="+a.destinationId+"&currency="+a.currency+"&pageLister.pageSize="+Viator.Filter.view.pageSize+Viator.Filter.controller.filterQuery(a.filterSpec)+Viator.Filter.controller.sortBy(b)+Viator.Filter.controller.elevate(a.filterSpec,b)+(a.listSpec.pageIndex>0?"&pageLister.page="+a.listSpec.pageIndex:"")},_listProducts:function(a,b){if(this._listProductsOverride)this._listProductsOverride(a,b);else{Viator.Filter.view.selectedSortBy=a.listSpec.sortBy,Viator.Filter.view.selectedLayout=a.listSpec.layout;var c=this;Viator.Filter.view.listingContainer.trigger("productsQueried"),$.ajax({dataType:"json",url:Viator.Filter.controller._listProductsQueryUrl(a),headers:{"X-Requested-With":"ViatorPageView"}}).done(function(d){var e={filterSpec:a.filterSpec,listSpec:a.listSpec};b&&(e.callback=b),c.renderProductListing(d,e)}).fail(function(a,b,c){console.warn("Failed to retrieve product list. "+b+" >> "+c),Viator.Filter.view.listingContainer.trigger("productsQueryResponded",{error:c})})}},renderProductListing:function(a,b){if(a&&a.pagedList){a.pageLister.navElements=Viator.Filter.controller.pageNavElements(a.pageLister);var c=this;$.when(Viator.Filter.view.handlebarsCustomizationPromise).done(function(){var d=b.templateId?Handlebars.compile($("#"+b.templateId).html(),{compat:!0}):Viator.Filter.productGridTemplate;Viator.Filter.view.listingContainer.empty().append(d({products:a.pagedList,graphicslibBasePath:Viator.Filter.view.graphicslibBasePath,priceFromLabel:Viator.Filter.view.priceDisplay.label,currencySign:Viator.Filter.view.priceDisplay.currencySign,priceFromSuffix:Viator.Filter.view.priceDisplay.suffix,textTruncationThreshold:100,titleTruncationThreshold:70,pager:a.pageLister,links:a.links,sortCriteria:b.listSpec.sortBy,layout:b.listSpec.layout,filterSpec:b.filterSpec,filterLabels:Viator.Filter.view.labels,selectedGroupNames:c.selectedGroupNames(b.filterSpec.selections,Viator.Filter.view.labels),dateRawFormat:Viator.Filter.view.dateFormat,dateDisplayFormat:Viator.Filter.view.dateDisplayFormat})),b.callback&&b.callback(),Viator.Filter.view.listingContainer.trigger("productsQueryResponded",{response:a})}).fail(function(a){Viator.Filter.view.listingContainer.trigger("productsQueryResponded",{error:a}),console.error("Failed to render product listing due to: "+a)})}else b.callback&&b.callback()},logBrowserHistory:function(a){history&&history.pushState&&history.pushState(a,"filtered/sorted/paged list",location.pathname+location.search+"#"+encodeURIComponent(JSON.stringify(a)))},replaceBrowserHistory:function(a){history&&history.replaceState&&history.replaceState(a,"filtered/sorted/paged list",location.pathname+location.search+"#"+encodeURIComponent(JSON.stringify(a)))},resetFilters:function(){$("[data-filter]").prop("checked",!1).trigger("change"),Viator.Filter.view.fromDatePicker.setDate(null),Viator.Filter.view.toDatePicker.setDate(null);var a=clickStream.init("/clickStreamAction.jspa");a.postStream("ClearAllClicked")},selectedGroupNames:function(a,b){return a?$.map(a,function(a){return"groupId"===a.name?b[a.name+":"+a.value]:null}):[]},validQueryStateString:function(a){return a&&a.indexOf("filterSpec")>-1},queryStateInUrl:function(){var a=location.hash;return a&&a.length>1&&(a=decodeURIComponent(a.substr(1)),this.validQueryStateString(a))?JSON.parse(a):null}},$(function(){Viator.Filter.view.filterContainer.on("click",'[type="checkbox"][data-filter]:not([name="groupId"]):not([name="topPicks"])',function(){Viator.Filter.controller.listProducts({sortBy:Viator.Filter.view.selectedSortBy,layout:Viator.Filter.view.selectedLayout})}),Viator.Filter.view.handlebarsCustomizationPromise.done(function(){Viator.Filter.productGridTemplate=Handlebars.compile($("#product-grid-template").html(),{compat:!0})}).fail(function(a){console.error("Failed to compile listing layout templates due to "+a)})}),window.onpopstate=function(a){Viator.Filter.view.render.done(function(){a.state?Viator.Filter.controller.replayQuery(a.state):window.location.reload()})},Viator.Filter.view.selectedLayout="grid",Viator.Filter.view.topPicksPromise=$.Deferred(),$.ajax({dataType:"json",url:"/api/product.jspa?destinationID="+Viator.Filter.model.destinationId+"&criteria.topPicks=true"}).done(function(a){var b=null;a&&a.pagedList&&a.pagedList.length>0&&(b=$.map(a.pagedList,function(a){return a.isTopPick&&a.isTopPick.length>0&&"true"===a.isTopPick[0]?a.sts_productCode[0]:null})),Viator.Filter.view.topPicksPromise.resolve(b)}).fail(function(){Viator.Filter.view.topPicksPromise.reject()}),$(function(){Viator.Filter.view.handlebarsCustomizationPromise.done(function(){Viator.Filter.view.fromDatePicker=new Pikaday({field:$("#fromDate")[0],format:Viator.Filter.view.dateDisplayFormat,minDate:new Date,onSelect:function(a){},onClose:function(a){this._o.field.value||this.setDate(null),Viator.Filter.controller.listProducts({sortBy:Viator.Filter.view.selectedSortBy,layout:Viator.Filter.view.selectedLayout}),Viator.Filter.view.filterContainer.trigger("filterEvent",{type:"availDate",value:this._o.field.value})}}),Viator.Filter.view.toDatePicker=new Pikaday({field:$("#toDate")[0],format:Viator.Filter.view.dateDisplayFormat,minDate:new Date,onSelect:function(a){},onClose:function(a){this._o.field.value||this.setDate(null),Viator.Filter.controller.listProducts({sortBy:Viator.Filter.view.selectedSortBy,layout:Viator.Filter.view.selectedLayout}),Viator.Filter.view.filterContainer.trigger("filterEvent",{type:"availDate",value:this._o.field.value})}}),Viator.Filter.view.groupFilters=Viator.Filter.view.groupFilters||{},Viator.Filter.view.groupFilters.elem=$(".group-filters"),Viator.Filter.view.groupFilters.build=function(a){Viator.Filter.view.groupFilters.elem.find("input").each(function(){var b=$(this),c=b.attr("value");c&&b.parent().find(".xxsmall").text(a&&a[c]?" ("+a[c]+")":"")}),Viator.Filter.view.groupFilters.elem.find("li:eq(0)").before('<li><label class="pvs plm prm"><input type="checkbox" name="topPicks" value="true" data-filter="true" data-filter-label="Top Insider\'s Pick" class="mls mrs mtxs unit hidden" /><span class="filter-text">Top Insider\'s Pick <span class="xxsmall"></span></span></label></li>'),Viator.Filter.view.topPicksPromise.done(function(a){a&&a.length>0?$('[name="topPicks"] ~ .filter-text .xxsmall').text("("+a.length+")"):$('[name="topPicks"]').parent().hide()}).fail(function(){$('[name="topPicks"]').parent().hide()}),Viator.Filter.view.labels={},$.each($("[data-filter-label]"),function(a,b){var c=$(b);Viator.Filter.view.labels[c.attr("name")+":"+c.attr("value")]=c.attr("data-filter-label")}),Viator.Filter.view.filterContainer.on("click",'[type="checkbox"][data-filter][name="groupId"], [type="checkbox"][data-filter][name="topPicks"]',function(){return Viator.Filter.controller.singleSelection(".group-filters",$(this)),!1}),Viator.Filter.view.filterContainer.on("click",".group-filters li",function(){return Viator.Filter.controller.singleSelection(".group-filters",$(this).find("input")),!1}),Viator.Filter.view.filterContainer.trigger("filtersReady"),Viator.Filter.view.render.resolve()},$.ajax({dataType:"json",url:"/api/product.jspa?destinationID="+Viator.Filter.model.destinationId+"&pageLister.pageSize=0"}).done(function(a){a&&a.facetCounts&&Viator.Filter.view.groupFilters.build(a.facetCounts.facet_fields.facetData.it_groupIDs)}).fail(function(a,b,c){console.warn("Failed to retrieve facet data. "+b+" >> "+c),Viator.Filter.view.groupFilters.build()}),Viator.Filter.view.filterContainer.on("change",'[type="checkbox"][data-filter]',function(){$this=$(this),$this.is(":checked")?$this.parent().addClass("current-link"):$this.parent().removeClass("current-link")}),$("body").on("click","[data-filter-ref]",function(){var a=$(this).attr("data-filter-ref").split(":");a&&($('[name="'+a[0]+'"][value="'+a[1]+'"]').prop("checked",!1).trigger("change"),Viator.Filter.controller.listProducts({sortBy:Viator.Filter.view.selectedSortBy,layout:Viator.Filter.view.selectedLayout}))})}).fail(function(a){console.error("Failed to render filter component due to: "+a)})}),$(function(){Viator.Filter.view.filterContainer.on("filtersReady",function(a,b){var c=Viator.Filter.controller.queryStateInUrl();c?(Viator.Filter.controller.replayQuery(c,function(){Viator.Filter.view.initialListRendered.resolve()}),Viator.Filter.controller.replaceBrowserHistory(c)):(Viator.Filter.model.listOnReady?$.when(Viator.Filter.view.handlebarsCustomizationPromise).done(function(){Viator.Filter.controller.listProducts({sortBy:Viator.Filter.view.selectedSortBy,layout:Viator.Filter.view.selectedLayout})}):Viator.Filter.view.topPicksPromise.done(function(a){a&&a.length&&$.each(a,function(a,b){$("#top-pick-badge-"+b).css("visibility","")})}),Viator.Filter.view.initialListRendered.resolve())}),Viator.Filter.view.listingContainer.on("productsQueried",function(a,b){Viator.Filter.view.busyIndicator.show()}),Viator.Filter.view.listingContainer.on("productsQueryResponded",function(a,b){Viator.Filter.view.busyIndicator.hide()})});